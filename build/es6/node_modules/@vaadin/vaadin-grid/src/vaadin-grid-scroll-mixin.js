/**
@license
Copyright (c) 2017 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
*/
import{Debouncer as e}from"../../../@polymer/polymer/lib/utils/debounce.js";import{animationFrame as t,timeOut as s,microTask as r}from"../../../@polymer/polymer/lib/utils/async.js";export const ScrollMixin=i=>class ScrollMixin extends i{get _timeouts(){return{SCROLLING:500,IGNORE_WHEEL:500}}static get properties(){return{_frozenCells:{type:Array,value:()=>[]},_rowWithFocusedElement:Element,_deltaYAcc:{type:Number,value:0},_useSticky:{type:Boolean,value:window.CSS&&window.CSS.supports&&(window.CSS.supports("position","sticky")||window.CSS.supports("position","-webkit-sticky"))}}}static get observers(){return["_scrollViewportHeightUpdated(_viewportHeight)"]}set _scrollTop(e){this.$.table.scrollTop=e}get _scrollTop(){return this.$.table.scrollTop}constructor(){super(),this._scrollLineHeight=this._getScrollLineHeight()}_getScrollLineHeight(){const e=document.createElement("div");e.style.fontSize="initial",e.style.display="none",document.body.appendChild(e);const t=window.getComputedStyle(e).fontSize;return document.body.removeChild(e),t?window.parseInt(t):void 0}_scrollViewportHeightUpdated(e){this._scrollPageHeight=e-this.$.header.clientHeight-this.$.footer.clientHeight-this._scrollLineHeight}ready(){super.ready(),this.$.outerscroller=document.createElement("div"),this.scrollTarget=this.$.table,this.addEventListener("wheel",this._onWheel),this.$.items.addEventListener("focusin",(e=>{const t=e.composedPath().indexOf(this.$.items);this._rowWithFocusedElement=e.composedPath()[t-1]})),this.$.items.addEventListener("focusout",(()=>this._rowWithFocusedElement=void 0)),this.scrollTarget.addEventListener("mousedown",(()=>this.__mouseDown=!0)),this.scrollTarget.addEventListener("mouseup",(()=>{this.__mouseDown=!1,this.__pendingReorder&&(this.__pendingReorder=!1,setTimeout((()=>this._reorderRows()),this._timeouts.SCROLLING))}))}scrollToIndex(e){this._accessIronListAPI((()=>super.scrollToIndex(e)))}_onWheel(r){if(r.ctrlKey||this._hasScrolledAncestor(r.target,r.deltaX,r.deltaY))return;const i=this.$.table;let o=r.deltaY;if(r.deltaMode===WheelEvent.DOM_DELTA_LINE?o*=this._scrollLineHeight:r.deltaMode===WheelEvent.DOM_DELTA_PAGE&&(o*=this._scrollPageHeight),this._wheelAnimationFrame)return this._deltaYAcc+=o,void r.preventDefault();o+=this._deltaYAcc,this._deltaYAcc=0,this._wheelAnimationFrame=!0,this._debouncerWheelAnimationFrame=e.debounce(this._debouncerWheelAnimationFrame,t,(()=>this._wheelAnimationFrame=!1));var l=Math.abs(r.deltaX)+Math.abs(o);this._canScroll(i,r.deltaX,o)?(r.preventDefault(),i.scrollTop+=o,i.scrollLeft+=r.deltaX,this._scrollHandler(),this._hasResidualMomentum=!0,this._ignoreNewWheel=!0,this._debouncerIgnoreNewWheel=e.debounce(this._debouncerIgnoreNewWheel,s.after(this._timeouts.IGNORE_WHEEL),(()=>this._ignoreNewWheel=!1))):this._hasResidualMomentum&&l<=this._previousMomentum||this._ignoreNewWheel?r.preventDefault():l>this._previousMomentum&&(this._hasResidualMomentum=!1),this._previousMomentum=l}_hasScrolledAncestor(e,t,s){return"vaadin-grid-cell-content"!==e.localName&&(!(!this._canScroll(e,t,s)||-1===["auto","scroll"].indexOf(getComputedStyle(e).overflow))||(e!==this&&e.parentElement?this._hasScrolledAncestor(e.parentElement,t,s):void 0))}_canScroll(e,t,s){return s>0&&e.scrollTop<e.scrollHeight-e.offsetHeight||s<0&&e.scrollTop>0||t>0&&e.scrollLeft<e.scrollWidth-e.offsetWidth||t<0&&e.scrollLeft>0}_scheduleScrolling(){this._scrollingFrame||(this._scrollingFrame=requestAnimationFrame((()=>this._toggleAttribute("scrolling",!0,this.$.scroller)))),this._debounceScrolling=e.debounce(this._debounceScrolling,s.after(this._timeouts.SCROLLING),(()=>{cancelAnimationFrame(this._scrollingFrame),delete this._scrollingFrame,this._toggleAttribute("scrolling",!1,this.$.scroller),this._reorderRows()}))}_afterScroll(){this._translateStationaryElements(),this.hasAttribute("reordering")||this._scheduleScrolling(),this._updateOverflow()}_updateOverflow(){let s="";const r=this.$.table;r.scrollTop<r.scrollHeight-r.clientHeight&&(s+=" bottom"),r.scrollTop>0&&(s+=" top"),r.scrollLeft<r.scrollWidth-r.clientWidth&&(s+=" right"),r.scrollLeft>0&&(s+=" left"),this._debounceOverflow=e.debounce(this._debounceOverflow,t,(()=>{const e=s.trim();e.length>0&&this.getAttribute("overflow")!==e?this.setAttribute("overflow",e):0==e.length&&this.hasAttribute("overflow")&&this.removeAttribute("overflow")}))}_reorderRows(){if(this.__mouseDown)return void(this.__pendingReorder=!0);const e=this.$.items,t=e.querySelectorAll("tr");if(!t.length)return;const s=this._virtualStart+this._vidxOffset,r=this._rowWithFocusedElement||Array.from(t).filter((e=>!e.hidden))[0];if(!r)return;const i=r.index-s,o=Array.from(t).indexOf(r)-i;if(o>0)for(let s=0;s<o;s++)e.appendChild(t[s]);else if(o<0)for(let s=t.length+o;s<t.length;s++)e.insertBefore(t[s],t[0]);if(this._safari){const{transform:e}=this.$.header.style;this.$.header.style.transform="",setTimeout((()=>this.$.header.style.transform=e))}}_frozenCellsChanged(){this._debouncerCacheElements=e.debounce(this._debouncerCacheElements,r,(()=>{Array.from(this.shadowRoot.querySelectorAll('[part~="cell"]')).forEach((function(e){e.style.transform=""})),this._frozenCells=Array.prototype.slice.call(this.$.table.querySelectorAll("[frozen]")),this._updateScrollerMeasurements(),this._translateStationaryElements()})),this._updateLastFrozen()}_updateScrollerMeasurements(){this._frozenCells.length>0&&this.__isRTL&&(this.__scrollerMetrics={scrollWidth:this.$.table.scrollWidth,clientWidth:this.$.table.clientWidth})}_updateLastFrozen(){if(!this._columnTree)return;const e=this._columnTree[this._columnTree.length-1].slice(0);e.sort(((e,t)=>e._order-t._order));const t=e.reduce(((e,t,s)=>(t._lastFrozen=!1,t.frozen&&!t.hidden?s:e)),void 0);void 0!==t&&(e[t]._lastFrozen=!0)}_translateStationaryElements(){const e=Math.max(0,this._scrollLeft),t=Math.max(0,this._scrollTop);let s=0,r=0,i=0;if(this._useSticky||(s=e,r=t,i=this.$.table.clientHeight-this.$.footer.offsetHeight-this.$.footer.offsetTop),this.$.header.style.transform=this._getTranslate(-e+s,r),this.$.footer.style.transform=this._getTranslate(-e+s,r+i),this.$.items.style.transform=this._getTranslate(-e+s,0),this._frozenCells.length>0){const e=this.__isRTL?this.__getNormalizedScrollLeft(this.$.table)+this.__scrollerMetrics.clientWidth-this.__scrollerMetrics.scrollWidth:this._scrollLeft;for(var o=this._getTranslate(e,0),l=0;l<this._frozenCells.length;l++)this._frozenCells[l].style.transform=o}}_getTranslate(e,t){return`translate(${e}px, ${t}px)`}};